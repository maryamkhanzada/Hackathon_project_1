# Appendix D: Lab Setup Tips & Troubleshooting

Practical guidance for setting up your development environment for Physical AI and humanoid robotics, from hardware to software.

## Initial System Setup

### Operating System Installation

**Ubuntu 22.04 LTS Setup** (Recommended):

1. **Download Ubuntu 22.04 LTS** from https://ubuntu.com/download/desktop
2. **Create bootable USB** with Rufus (Windows) or dd (Linux/Mac):
   ```bash
   # Linux/Mac example
   sudo dd if=ubuntu-22.04.iso of=/dev/sdX bs=4M status=progress
   ```
3. **Partition recommendations**:
   - Root (`/`): 50GB minimum, 100GB recommended
   - Home (`/home`): Remaining space
   - Swap: 8-16GB (equal to RAM for hibernation)
   - EFI System Partition: 512MB (if UEFI)

4. **Post-installation updates**:
   ```bash
   sudo apt update && sudo apt upgrade -y
   sudo apt install build-essential git curl wget vim tmux htop
   ```

### NVIDIA Driver Installation

**Critical for Isaac Sim and GPU-accelerated perception**:

```bash
# Check GPU
lspci | grep -i nvidia

# Add NVIDIA PPA
sudo add-apt-repository ppa:graphics-drivers/ppa
sudo apt update

# Install recommended driver (530+ for Isaac Sim)
sudo ubuntu-drivers autoinstall

# Or specific version
sudo apt install nvidia-driver-535

# Reboot
sudo reboot

# Verify installation
nvidia-smi
```

**Expected output**: GPU name, driver version, CUDA version.

**Troubleshooting**:
- If black screen after reboot: Boot to recovery mode, run `sudo ubuntu-drivers autoinstall`
- If `nvidia-smi` shows "No devices found": Check secure boot is disabled in BIOS

### Environment Setup Options

#### Option 1: Dual-Boot (Recommended for Performance)

**Pros**:
- Native Linux performance
- Full GPU access for Isaac Sim
- No virtualization overhead
- Best for RL training and real-time control

**Cons**:
- Requires disk partitioning
- Reboot to switch OS
- Windows tools not available in Linux

**When to use**: Primary development machine, thesis work, capstone project

#### Option 2: Virtual Machine (VirtualBox/VMware)

**Pros**:
- Easy to set up and remove
- Snapshots for backup
- Run Windows and Linux simultaneously

**Cons**:
- Limited GPU passthrough
- Performance penalty (20-30%)
- Not suitable for Isaac Sim

**When to use**: ROS 2 basics (Module 1), initial learning, Gazebo simulation

**Setup**:
```bash
# VirtualBox settings
- RAM: 8GB minimum, 16GB recommended
- CPU: 4+ cores
- Graphics: Enable 3D acceleration
- Shared clipboard: Bidirectional
```

#### Option 3: WSL2 (Windows Subsystem for Linux)

**Pros**:
- Good balance for Windows users
- Native file system access
- GPU support (with CUDA on WSL)
- No reboot needed

**Cons**:
- GUI apps require X server (or WSLg)
- Some hardware access limitations
- Not ideal for Isaac Sim

**Setup**:
```powershell
# Windows PowerShell (Administrator)
wsl --install -d Ubuntu-22.04
wsl --set-version Ubuntu-22.04 2

# Inside WSL
sudo apt update && sudo apt upgrade -y
```

**GUI Setup for WSL2**:
```bash
# Install X server on Windows: VcXsrv or Xming
# In WSL
export DISPLAY=$(cat /etc/resolv.conf | grep nameserver | awk '{print $2}'):0
echo 'export DISPLAY=$(cat /etc/resolv.conf | grep nameserver | awk '"'"'{print $2}'"'"'):0' >> ~/.bashrc
```

#### Option 4: Docker (For Reproducible Environments)

**Pros**:
- Consistent environment across machines
- Easy cleanup and fresh starts
- Isolation from host system
- Team collaboration

**Cons**:
- GUI apps require X forwarding
- Learning curve for Docker
- File permissions issues

**Setup**:
```bash
# Install Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER
# Log out and back in

# Install NVIDIA Container Toolkit (for GPU)
distribution=$(. /etc/os-release;echo $ID$VERSION_ID)
curl -s -L https://nvidia.github.io/nvidia-docker/gpgkey | sudo apt-key add -
curl -s -L https://nvidia.github.io/nvidia-docker/$distribution/nvidia-docker.list | sudo tee /etc/apt/sources.list.d/nvidia-docker.list
sudo apt update && sudo apt install -y nvidia-container-toolkit
sudo systemctl restart docker

# Test GPU in Docker
docker run --rm --gpus all nvidia/cuda:11.8.0-base-ubuntu22.04 nvidia-smi
```

**ROS 2 Docker Image**:
```bash
# Pull ROS 2 Humble with desktop tools
docker pull osrf/ros:humble-desktop-full

# Run with GUI support
xhost +local:docker
docker run -it --rm \
  --gpus all \
  --env="DISPLAY=$DISPLAY" \
  --volume="/tmp/.X11-unix:/tmp/.X11-unix:rw" \
  --volume="$HOME/ros2_ws:/root/ros2_ws" \
  --name ros2-dev \
  osrf/ros:humble-desktop-full \
  bash
```

## Module-Specific Setup

### Module 1: ROS 2 Humble Installation

**Standard Installation**:
```bash
# Set locale
sudo apt install locales
sudo locale-gen en_US en_US.UTF-8
sudo update-locale LC_ALL=en_US.UTF-8 LANG=en_US.UTF-8
export LANG=en_US.UTF-8

# Add ROS 2 apt repository
sudo apt install software-properties-common
sudo add-apt-repository universe
sudo apt update && sudo apt install curl -y
sudo curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(. /etc/os-release && echo $UBUNTU_CODENAME) main" | sudo tee /etc/apt/sources.list.d/ros2.list > /dev/null

# Install ROS 2 Humble
sudo apt update
sudo apt install ros-humble-desktop-full

# Install colcon and other tools
sudo apt install python3-colcon-common-extensions python3-rosdep python3-vcstool

# Initialize rosdep
sudo rosdep init
rosdep update
```

**Workspace Setup**:
```bash
# Create workspace
mkdir -p ~/ros2_ws/src
cd ~/ros2_ws
colcon build --symlink-install

# Source workspace in bashrc
echo "source /opt/ros/humble/setup.bash" >> ~/.bashrc
echo "source ~/ros2_ws/install/setup.bash" >> ~/.bashrc
source ~/.bashrc
```

**Essential Packages**:
```bash
sudo apt install \
  ros-humble-rqt* \
  ros-humble-rviz2 \
  ros-humble-gazebo-ros-pkgs \
  ros-humble-navigation2 \
  ros-humble-nav2-bringup \
  ros-humble-moveit \
  ros-humble-robot-state-publisher \
  ros-humble-joint-state-publisher \
  ros-humble-xacro
```

**Common Issues**:

1. **"Package not found" errors**:
   ```bash
   # Check package availability
   apt search ros-humble-<package-name>

   # Rebuild workspace
   cd ~/ros2_ws
   colcon build --symlink-install
   source install/setup.bash
   ```

2. **"Cannot communicate with other nodes"**:
   ```bash
   # Check ROS_DOMAIN_ID
   echo $ROS_DOMAIN_ID

   # Set domain ID (0-101)
   export ROS_DOMAIN_ID=42
   echo "export ROS_DOMAIN_ID=42" >> ~/.bashrc
   ```

3. **Permission denied on serial devices** (for hardware):
   ```bash
   sudo usermod -a -G dialout $USER
   # Log out and back in
   ```

### Module 2: Gazebo Classic Setup

**Installation**:
```bash
# Gazebo 11 (ships with ROS 2 Humble)
sudo apt install gazebo ros-humble-gazebo-ros-pkgs

# Test launch
gazebo --verbose
```

**Performance Optimization**:

1. **Reduce real-time factor** for faster-than-real-time simulation:
   ```xml
   <!-- In world file -->
   <physics type="ode">
     <real_time_update_rate>1000</real_time_update_rate>
     <max_step_size>0.001</max_step_size>
   </physics>
   ```

2. **Lower sensor update rates**:
   ```xml
   <update_rate>30.0</update_rate>  <!-- Instead of 60+ -->
   ```

3. **Disable GUI during headless training**:
   ```bash
   gzserver world.world  # No GUI, faster
   ```

4. **GPU ray tracing** for faster LiDAR simulation:
   ```xml
   <sensor type="gpu_ray">
   ```

**Common Gazebo Issues**:

1. **"Cannot find model" errors**:
   ```bash
   # Download Gazebo models
   git clone https://github.com/osrf/gazebo_models.git ~/gazebo_models
   export GAZEBO_MODEL_PATH=~/gazebo_models:$GAZEBO_MODEL_PATH
   echo "export GAZEBO_MODEL_PATH=~/gazebo_models:$GAZEBO_MODEL_PATH" >> ~/.bashrc
   ```

2. **Black screen or frozen simulation**:
   ```bash
   # Update graphics drivers
   # Reduce rendering quality in Gazebo GUI
   # Close other GPU-intensive applications
   ```

### Module 3: NVIDIA Isaac Sim Installation

**System Requirements Check**:
```bash
# GPU check
nvidia-smi
# Minimum: RTX 2060, Recommended: RTX 3080+

# VRAM check (need 8GB+)
nvidia-smi --query-gpu=memory.total --format=csv

# Driver version (need 525+)
nvidia-smi | grep "Driver Version"
```

**Installation Steps**:

1. **Install Omniverse Launcher**:
   ```bash
   # Download from https://www.nvidia.com/en-us/omniverse/download/
   chmod +x omniverse-launcher-linux.AppImage
   ./omniverse-launcher-linux.AppImage
   ```

2. **Install Isaac Sim** (via Omniverse Launcher):
   - Open Launcher → Exchange
   - Search "Isaac Sim"
   - Install version 2023.1.1 or later (~50GB download)

3. **Install Isaac ROS**:
   ```bash
   sudo apt install ros-humble-isaac-ros-visual-slam \
                    ros-humble-isaac-ros-dnn-inference \
                    ros-humble-isaac-ros-apriltag \
                    ros-humble-isaac-ros-image-pipeline
   ```

4. **Verify Installation**:
   ```bash
   # Launch Isaac Sim
   ~/.local/share/ov/pkg/isaac_sim-*/isaac-sim.sh

   # Should open Isaac Sim GUI
   ```

**Performance Tips**:

1. **Reduce physics substeps** during development:
   - Edit → Preferences → Physics → Physics Rate: 60 Hz

2. **Lower rendering quality**:
   - Viewport → Render Settings → Ray Tracing Samples: Low

3. **Use headless mode** for RL training:
   ```python
   from omni.isaac.kit import SimulationApp
   simulation_app = SimulationApp({"headless": True})
   ```

4. **Close unnecessary apps** to free VRAM:
   ```bash
   # Monitor VRAM usage
   watch -n 1 nvidia-smi
   ```

**Common Isaac Sim Issues**:

1. **Crash on launch**:
   ```bash
   # Update drivers to 535+
   sudo apt install nvidia-driver-535
   sudo reboot

   # Check VRAM (close Chrome, VSCode)
   nvidia-smi
   ```

2. **"Insufficient VRAM" error**:
   - Reduce scene complexity
   - Use lower-resolution textures
   - Disable ray tracing

3. **Slow simulation**:
   - Enable "Physics GPU" in settings
   - Reduce physics substeps
   - Use simplified collision meshes

### Module 4: OpenAI API and Whisper Setup

**OpenAI API Setup**:

1. **Get API key** from https://platform.openai.com/api-keys

2. **Store securely**:
   ```bash
   # Create .env file
   echo "OPENAI_API_KEY=sk-..." > ~/.openai_api_key
   chmod 600 ~/.openai_api_key

   # Load in bashrc
   echo 'export OPENAI_API_KEY=$(cat ~/.openai_api_key)' >> ~/.bashrc
   source ~/.bashrc
   ```

3. **Install Python package**:
   ```bash
   pip install openai==1.3.0
   ```

4. **Test API**:
   ```python
   import openai
   import os

   openai.api_key = os.environ.get("OPENAI_API_KEY")
   response = openai.ChatCompletion.create(
       model="gpt-4-turbo-preview",
       messages=[{"role": "user", "content": "Hello!"}]
   )
   print(response.choices[0].message.content)
   ```

**Whisper Local Installation**:

```bash
# Install FFmpeg (required)
sudo apt install ffmpeg

# Install Whisper
pip install openai-whisper

# Download model (one-time)
python -c "import whisper; whisper.load_model('base')"

# Test
whisper audio.mp3 --model base
```

**Model size comparison**:
- `tiny`: 39M params, ~1GB VRAM, fastest
- `base`: 74M params, ~1GB VRAM, good for real-time
- `small`: 244M params, ~2GB VRAM, better accuracy
- `medium`: 769M params, ~5GB VRAM, high accuracy
- `large`: 1550M params, ~10GB VRAM, best accuracy

**Voice input setup**:
```bash
# Install PyAudio for microphone
sudo apt install portaudio19-dev python3-pyaudio
pip install pyaudio

# Test microphone
python -c "import pyaudio; p = pyaudio.PyAudio(); print([p.get_device_info_by_index(i)['name'] for i in range(p.get_device_count())])"
```

## Hardware Integration

### Intel RealSense D435i Setup

**Driver Installation**:
```bash
# Add Intel RealSense repository
sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-key F6E65AC044F831AC80A06380C8B3A55A6F3EFCDE
sudo add-apt-repository "deb https://librealsense.intel.com/Debian/apt-repo $(lsb_release -cs) main"

# Install
sudo apt update
sudo apt install librealsense2-dkms librealsense2-utils librealsense2-dev

# ROS 2 wrapper
sudo apt install ros-humble-realsense2-camera

# Test
realsense-viewer
```

**Verify camera**:
```bash
# Should show camera serial number and model
rs-enumerate-devices

# Launch ROS 2 node
ros2 launch realsense2_camera rs_launch.py

# View topics
ros2 topic list | grep camera
```

**Common issues**:
- **"No device connected"**: Check USB 3.0 port (blue connector)
- **Low frame rate**: Reduce resolution or use USB 3.1/3.2 port

### LiDAR Setup (RPLidar A2)

**Installation**:
```bash
# Install ROS 2 package
sudo apt install ros-humble-rplidar-ros

# Grant serial port access
sudo chmod 666 /dev/ttyUSB0

# Launch
ros2 launch rplidar_ros view_rplidar_a2_launch.py
```

**Verify**:
```bash
ros2 topic echo /scan
```

## Network Configuration

### Multi-Machine ROS 2 Setup

**Same network communication**:

1. **Check connectivity**:
   ```bash
   # On both machines
   ping <other-machine-ip>
   ```

2. **Set ROS_DOMAIN_ID** (must be same on both):
   ```bash
   export ROS_DOMAIN_ID=42
   ```

3. **Test**:
   ```bash
   # Machine 1
   ros2 run demo_nodes_cpp talker

   # Machine 2
   ros2 run demo_nodes_cpp listener
   ```

**Firewall configuration**:
```bash
# Allow ROS 2 DDS multicast
sudo ufw allow from 192.168.1.0/24
sudo ufw enable
```

### SSH Setup for Remote Robots

```bash
# Generate SSH key
ssh-keygen -t ed25519 -C "your_email@example.com"

# Copy to robot
ssh-copy-id user@robot-ip

# Test passwordless login
ssh user@robot-ip
```

## Development Workflow Tips

### Terminal Multiplexing with tmux

```bash
# Install
sudo apt install tmux

# Start session
tmux new -s ros2

# Split panes
Ctrl+b "  # Horizontal split
Ctrl+b %  # Vertical split

# Navigate panes
Ctrl+b arrow-keys

# Detach session
Ctrl+b d

# Reattach
tmux attach -t ros2
```

**Example ROS 2 workflow**:
- Pane 1: roscore / ROS 2 daemon
- Pane 2: Launch simulation
- Pane 3: Launch perception nodes
- Pane 4: Run scripts / debugging

### VS Code Extensions

**Essential**:
- ROS (Microsoft)
- Python (Microsoft)
- C/C++ (Microsoft)
- CMake Tools
- XML Tools (for URDF)

**Configuration** (`.vscode/settings.json`):
```json
{
  "python.autoComplete.extraPaths": [
    "/opt/ros/humble/lib/python3.10/site-packages"
  ],
  "ros.distro": "humble"
}
```

### Git Best Practices

```bash
# Ignore build artifacts
echo "build/\ninstall/\nlog/\n*.pyc\n__pycache__/" > .gitignore

# Initial commit
git init
git add .
git commit -m "Initial commit"

# Create repo and push
gh repo create my-robot-project --public
git remote add origin https://github.com/user/my-robot-project.git
git push -u origin main
```

## Troubleshooting Guide

### ROS 2 Issues

**"Package not found"**:
```bash
# Check if installed
dpkg -l | grep ros-humble-<package>

# Reinstall
sudo apt install --reinstall ros-humble-<package>

# Source workspace
source /opt/ros/humble/setup.bash
```

**"No executable found"**:
```bash
# Rebuild with symlink-install
cd ~/ros2_ws
colcon build --symlink-install
source install/setup.bash
```

**"DDS communication failing"**:
```bash
# Check DDS middleware
echo $RMW_IMPLEMENTATION

# Try cyclonedds
sudo apt install ros-humble-rmw-cyclonedds-cpp
export RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
```

### Gazebo Issues

**"libcurl.so.4 not found"**:
```bash
sudo apt install libcurl4
```

**"VMware detected, GPU acceleration disabled"**:
```bash
# In VM settings, enable 3D acceleration
# Or use software rendering
export LIBGL_ALWAYS_SOFTWARE=1
```

### NVIDIA Isaac Sim Issues

**"Nucleus server not connected"**:
- Open Omniverse Launcher → Nucleus
- Start local Nucleus server
- Restart Isaac Sim

**"Cannot load USD file"**:
```bash
# Check file path
# Verify file permissions
chmod +r <path-to-usd-file>
```

### Python Issues

**"ModuleNotFoundError"**:
```bash
# Check Python version
python3 --version  # Should be 3.10+

# Reinstall package
pip install --force-reinstall <package>

# Check installation path
pip show <package>
```

## Performance Optimization

### CPU Optimization

```bash
# Check CPU governor
cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor

# Set to performance mode
echo performance | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor
```

### GPU Optimization

```bash
# Set maximum performance mode
sudo nvidia-smi -pm 1
sudo nvidia-smi -pl 300  # Set power limit (adjust for your GPU)

# Monitor GPU
watch -n 1 nvidia-smi
```

### Disk I/O Optimization

```bash
# Use SSD for workspace
# Check I/O scheduler
cat /sys/block/sda/queue/scheduler

# Set to deadline or mq-deadline for SSDs
echo mq-deadline | sudo tee /sys/block/sda/queue/scheduler
```

## Backup and Recovery

### Workspace Backup

```bash
# Backup script
#!/bin/bash
DATE=$(date +%Y%m%d)
tar -czf ~/backup-ros2-$DATE.tar.gz \
  ~/ros2_ws/src \
  ~/.bashrc \
  ~/.vscode \
  ~/.config/rviz2

echo "Backup created: ~/backup-ros2-$DATE.tar.gz"
```

### Docker Snapshots

```bash
# Commit running container
docker commit ros2-dev my-ros2-snapshot:latest

# Save to file
docker save my-ros2-snapshot:latest | gzip > ros2-snapshot-$(date +%Y%m%d).tar.gz
```

## Cloud-Based Alternatives

### Google Colab for Quick Experiments

```python
# Install ROS 2 in Colab (basic packages only)
!apt update
!apt install -y ros-humble-ros-base
!source /opt/ros/humble/setup.bash && ros2 --version
```

**Limitations**: No GUI, limited runtime, no GPU for free tier.

### AWS RoboMaker

1. Create AWS account
2. Launch RoboMaker development environment
3. Pre-configured with ROS 2, Gazebo, RViz
4. Cost: ~$0.50-1.00/hour

## Safety and Best Practices

### Lab Safety

1. **Emergency stop**: Always within arm's reach
2. **Physical barriers**: Around humanoid test area
3. **Power limits**: Start with 20-30% motor power
4. **Supervision**: Never leave autonomous system unattended
5. **Workspaces**: Clear obstacles in navigation area

### Software Safety

1. **Rate limiting**: Cap velocity commands
   ```python
   MAX_LINEAR_VEL = 0.5  # m/s
   MAX_ANGULAR_VEL = 1.0  # rad/s
   cmd_vel.linear.x = min(cmd_vel.linear.x, MAX_LINEAR_VEL)
   ```

2. **Timeouts**: Implement watchdog timers
   ```python
   COMMAND_TIMEOUT = 1.0  # seconds
   if (current_time - last_command_time) > COMMAND_TIMEOUT:
       stop_robot()
   ```

3. **Sanity checks**: Validate sensor data
   ```python
   if distance < 0 or distance > MAX_SENSOR_RANGE:
       # Invalid sensor reading, use default
       distance = MAX_SENSOR_RANGE
   ```

## Checklist for First-Time Setup

- [ ] Ubuntu 22.04 LTS installed and updated
- [ ] NVIDIA drivers installed (if applicable)
- [ ] ROS 2 Humble installed and sourced
- [ ] Workspace created and built successfully
- [ ] RViz2 and Gazebo launch without errors
- [ ] `ros2 topic list` shows system topics
- [ ] Docker installed (if using)
- [ ] OpenAI API key configured
- [ ] Camera/sensors detected (if physical)
- [ ] Git configured with username and email
- [ ] VS Code with ROS extension installed
- [ ] Backup script created

---

**Pro Tips**:
1. Start simple - get Module 1 working before adding complexity
2. Document your setup - future you will thank you
3. Use version control from day one
4. Test in simulation before deploying to hardware
5. Join ROS Discourse and robotics communities for support
6. Keep a lab notebook - track issues and solutions

**Emergency Recovery**:
If everything breaks, you can always:
```bash
# Nuclear option - fresh ROS 2 workspace
rm -rf ~/ros2_ws
mkdir -p ~/ros2_ws/src
cd ~/ros2_ws
colcon build
source install/setup.bash
```

Good luck with your Physical AI journey!
