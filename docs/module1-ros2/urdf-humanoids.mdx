# URDF for Humanoid Robots

The **Unified Robot Description Format (URDF)** is an XML-based format for representing robot models in ROS. For humanoid robots with complex kinematic chains, URDF provides the foundation for visualization, planning, and control.

## What is URDF?

URDF describes:
- **Links**: Rigid bodies (torso, thighs, shins, feet, arms, head)
- **Joints**: Connections between links (revolute, prismatic, fixed)
- **Visual geometry**: How the robot looks (meshes, primitives)
- **Collision geometry**: For collision detection (simplified shapes)
- **Inertial properties**: Mass, center of mass, inertia tensors
- **Sensors and actuators**: Cameras, LiDAR, joint motors

## Basic URDF Structure

```xml
<?xml version="1.0"?>
<robot name="simple_humanoid">
  <!-- Links -->
  <link name="base_link">
    <visual>
      <geometry>
        <box size="0.3 0.2 0.4"/>
      </geometry>
      <material name="blue">
        <color rgba="0 0 0.8 1"/>
      </material>
    </visual>
    <collision>
      <geometry>
        <box size="0.3 0.2 0.4"/>
      </geometry>
    </collision>
    <inertial>
      <mass value="10.0"/>
      <inertia ixx="0.4" ixy="0" ixz="0" iyy="0.5" iyz="0" izz="0.3"/>
    </inertial>
  </link>

  <!-- Joints -->
  <joint name="hip_joint" type="revolute">
    <parent link="base_link"/>
    <child link="left_thigh"/>
    <origin xyz="0 0.1 -0.2" rpy="0 0 0"/>
    <axis xyz="1 0 0"/>
    <limit lower="-1.57" upper="1.57" effort="100" velocity="1.0"/>
  </joint>

  <link name="left_thigh">
    <!-- ... -->
  </link>
</robot>
```

## Humanoid Kinematic Chain

A typical humanoid has a tree structure:

```
              [head]
                |
            [torso/base]
           /     |     \
    [left_arm] [spine] [right_arm]
                |
         [pelvis/hips]
           /        \
    [left_leg]   [right_leg]
```

Each limb is a serial kinematic chain:
- **Leg**: hip (3 DOF) → knee (1 DOF) → ankle (2 DOF) = 6 DOF per leg
- **Arm**: shoulder (3 DOF) → elbow (1 DOF) → wrist (2 DOF) = 6 DOF per arm
- **Total**: 12-20+ DOF for typical humanoids

## Links and Joints

### Link Definition

```xml
<link name="left_thigh">
  <!-- Visual representation -->
  <visual>
    <origin xyz="0 0 -0.2" rpy="0 0 0"/>
    <geometry>
      <cylinder radius="0.05" length="0.4"/>
    </geometry>
    <material name="gray">
      <color rgba="0.5 0.5 0.5 1"/>
    </material>
  </visual>

  <!-- Collision geometry (simplified) -->
  <collision>
    <origin xyz="0 0 -0.2" rpy="0 0 0"/>
    <geometry>
      <cylinder radius="0.06" length="0.4"/>
    </geometry>
  </collision>

  <!-- Inertial properties -->
  <inertial>
    <origin xyz="0 0 -0.2" rpy="0 0 0"/>
    <mass value="5.0"/>
    <inertia ixx="0.067" ixy="0" ixz="0"
             iyy="0.067" iyz="0" izz="0.0125"/>
  </inertial>
</link>
```

### Joint Types

**Revolute** (rotation with limits):
```xml
<joint name="knee_joint" type="revolute">
  <parent link="left_thigh"/>
  <child link="left_shin"/>
  <origin xyz="0 0 -0.4" rpy="0 0 0"/>
  <axis xyz="0 1 0"/>  <!-- Rotate around Y axis -->
  <limit lower="0" upper="2.356" effort="150" velocity="2.0"/>
  <dynamics damping="0.7" friction="1.0"/>
</joint>
```

**Continuous** (unlimited rotation):
```xml
<joint name="wheel_joint" type="continuous">
  <axis xyz="0 1 0"/>
  <limit effort="10" velocity="5.0"/>
</joint>
```

**Prismatic** (linear motion):
```xml
<joint name="telescope_joint" type="prismatic">
  <axis xyz="0 0 1"/>
  <limit lower="0" upper="0.5" effort="100" velocity="0.5"/>
</joint>
```

**Fixed** (no motion):
```xml
<joint name="camera_mount" type="fixed">
  <parent link="head"/>
  <child link="camera_link"/>
  <origin xyz="0.05 0 0.1" rpy="0 0 0"/>
</joint>
```

## Coordinate Frames and Transforms

URDF uses **right-handed coordinate systems**:
- **X**: Forward (red)
- **Y**: Left (green)
- **Z**: Up (blue)

Origin `<origin xyz="x y z" rpy="roll pitch yaw"/>`:
- **xyz**: Translation in meters
- **rpy**: Rotation in radians (roll-pitch-yaw, applied in order: Z-Y-X)

## Meshes for Realistic Visualization

```xml
<visual>
  <geometry>
    <mesh filename="package://my_robot/meshes/torso.stl" scale="1 1 1"/>
  </geometry>
</visual>

<collision>
  <geometry>
    <!-- Simplified collision mesh -->
    <mesh filename="package://my_robot/meshes/torso_collision.stl"/>
  </geometry>
</collision>
```

**Best practices**:
- Use high-detail meshes for visual
- Use simplified meshes for collision (faster)
- Common formats: STL, DAE (Collada), OBJ
- Keep mesh files in `meshes/` directory

## Calculating Inertial Properties

Inertia tensors are required for physics simulation. Use tools like:

```python
# MeshLab, Blender, or SolidWorks for mesh analysis
# Or calculate for primitives:

# Box inertia (mass m, dimensions x,y,z)
ixx = (1/12) * m * (y^2 + z^2)
iyy = (1/12) * m * (x^2 + z^2)
izz = (1/12) * m * (x^2 + y^2)

# Cylinder inertia (mass m, radius r, height h)
ixx = (1/12) * m * (3*r^2 + h^2)  # perpendicular to axis
iyy = (1/12) * m * (3*r^2 + h^2)
izz = (1/2) * m * r^2  # along cylinder axis
```

## Sensors in URDF

### Camera

```xml
<link name="camera_link">
  <visual>
    <geometry>
      <box size="0.02 0.05 0.02"/>
    </geometry>
  </visual>
</link>

<joint name="camera_joint" type="fixed">
  <parent link="head"/>
  <child link="camera_link"/>
  <origin xyz="0.05 0 0.1" rpy="0 0 0"/>
</joint>
```

### LiDAR

```xml
<link name="lidar_link">
  <visual>
    <geometry>
      <cylinder radius="0.04" length="0.05"/>
    </geometry>
  </visual>
</link>
```

Sensor properties are typically defined in Gazebo plugins (SDF) or separate configuration files.

## XACRO: Macros for URDF

**XACRO** (XML Macros) reduces repetition in URDF files[^1].

### Basic Macro

```xml
<?xml version="1.0"?>
<robot name="humanoid" xmlns:xacro="http://www.ros.org/wiki/xacro">

  <!-- Property definitions -->
  <xacro:property name="thigh_length" value="0.4"/>
  <xacro:property name="thigh_radius" value="0.05"/>

  <!-- Macro for leg links -->
  <xacro:macro name="leg" params="prefix reflect">
    <link name="${prefix}_thigh">
      <visual>
        <geometry>
          <cylinder radius="${thigh_radius}" length="${thigh_length}"/>
        </geometry>
      </visual>
      <inertial>
        <mass value="5.0"/>
        <inertia ixx="0.067" ixy="0" ixz="0"
                 iyy="0.067" iyz="0" izz="0.0125"/>
      </inertial>
    </link>

    <joint name="${prefix}_hip" type="revolute">
      <parent link="pelvis"/>
      <child link="${prefix}_thigh"/>
      <origin xyz="0 ${reflect*0.1} 0" rpy="0 0 0"/>
      <axis xyz="1 0 0"/>
      <limit lower="-1.57" upper="1.57" effort="100" velocity="1.0"/>
    </joint>
  </xacro:macro>

  <!-- Instantiate macros -->
  <xacro:leg prefix="left" reflect="1"/>
  <xacro:leg prefix="right" reflect="-1"/>

</robot>
```

### Converting XACRO to URDF

```bash
# Convert xacro to urdf
ros2 run xacro xacro robot.urdf.xacro > robot.urdf

# Or use in launch files (automatic conversion)
robot_description = Command(['xacro ', urdf_file])
```

## Visualizing URDF in RViz2

### Check URDF Validity

```bash
# Install urdf tools
sudo apt install ros-humble-urdfdom-py

# Check URDF for errors
check_urdf robot.urdf

# Visualize structure
urdf_to_graphiz robot.urdf
```

### Launch RViz2 with URDF

```python
# launch/view_robot.launch.py
from launch import LaunchDescription
from launch_ros.actions import Node
from launch.actions import DeclareLaunchArgument
from launch.substitutions import LaunchConfiguration, Command
from launch_ros.parameter_descriptions import ParameterValue

def generate_launch_description():
    urdf_file = 'path/to/robot.urdf.xacro'

    robot_description = ParameterValue(
        Command(['xacro ', urdf_file]),
        value_type=str
    )

    return LaunchDescription([
        Node(
            package='robot_state_publisher',
            executable='robot_state_publisher',
            parameters=[{'robot_description': robot_description}]
        ),
        Node(
            package='joint_state_publisher_gui',
            executable='joint_state_publisher_gui'
        ),
        Node(
            package='rviz2',
            executable='rviz2',
            arguments=['-d', 'config/robot.rviz']
        )
    ])
```

```bash
ros2 launch my_robot view_robot.launch.py
```

##Complete Humanoid URDF Example

```xml
<?xml version="1.0"?>
<robot name="simple_humanoid" xmlns:xacro="http://www.ros.org/wiki/xacro">

  <!-- Base Link (Torso) -->
  <link name="base_link">
    <visual>
      <geometry>
        <box size="0.3 0.2 0.5"/>
      </geometry>
      <material name="blue"><color rgba="0 0 0.8 1"/></material>
    </visual>
    <collision>
      <geometry><box size="0.3 0.2 0.5"/></geometry>
    </collision>
    <inertial>
      <mass value="15.0"/>
      <inertia ixx="0.5" ixy="0" ixz="0" iyy="0.6" iyz="0" izz="0.4"/>
    </inertial>
  </link>

  <!-- Left Leg -->
  <joint name="left_hip" type="revolute">
    <parent link="base_link"/>
    <child link="left_thigh"/>
    <origin xyz="0 0.15 -0.25" rpy="0 0 0"/>
    <axis xyz="1 0 0"/>
    <limit lower="-1.57" upper="1.57" effort="150" velocity="2.0"/>
  </joint>

  <link name="left_thigh">
    <visual>
      <origin xyz="0 0 -0.2"/>
      <geometry><cylinder radius="0.05" length="0.4"/></geometry>
      <material name="gray"><color rgba="0.5 0.5 0.5 1"/></material>
    </visual>
    <collision>
      <origin xyz="0 0 -0.2"/>
      <geometry><cylinder radius="0.06" length="0.4"/></geometry>
    </collision>
    <inertial>
      <origin xyz="0 0 -0.2"/>
      <mass value="5.0"/>
      <inertia ixx="0.067" ixy="0" ixz="0" iyy="0.067" iyz="0" izz="0.0125"/>
    </inertial>
  </link>

  <joint name="left_knee" type="revolute">
    <parent link="left_thigh"/>
    <child link="left_shin"/>
    <origin xyz="0 0 -0.4" rpy="0 0 0"/>
    <axis xyz="0 1 0"/>
    <limit lower="0" upper="2.356" effort="150" velocity="2.0"/>
  </joint>

  <link name="left_shin">
    <visual>
      <origin xyz="0 0 -0.2"/>
      <geometry><cylinder radius="0.04" length="0.4"/></geometry>
      <material name="gray"/>
    </visual>
    <collision>
      <origin xyz="0 0 -0.2"/>
      <geometry><cylinder radius="0.05" length="0.4"/></geometry>
    </collision>
    <inertial>
      <origin xyz="0 0 -0.2"/>
      <mass value="3.0"/>
      <inertia ixx="0.04" ixy="0" ixz="0" iyy="0.04" iyz="0" izz="0.0075"/>
    </inertial>
  </link>

  <!-- Repeat for right leg, arms, head... -->

</robot>
```

## Best Practices

✅ **Use XACRO** for complex robots (reduces duplication)
✅ **Simplify collision geometry** (performance)
✅ **Accurate inertial properties** (stable simulation)
✅ **Consistent naming** (left_/right_ prefixes, _link/_joint suffixes)
✅ **Validate with check_urdf** (catch errors early)
✅ **Version control** your URDF files
✅ **Document joint limits** based on physical robot

## Common Issues

**Problem**: Robot falls through ground in simulation
**Solution**: Check collision geometry and inertial properties

**Problem**: Joints jitter or unstable
**Solution**: Add damping and friction to joint dynamics

**Problem**: Mesh not displaying
**Solution**: Check file paths use `package://` URIs

**Problem**: Robot explodes on startup
**Solution**: Verify inertia tensors (must be positive definite)

## Summary

URDF is essential for:
- Visualizing robots in RViz2
- Physics simulation in Gazebo
- Motion planning and kinematics
- Hardware integration

You've learned how to define links, joints, sensors, and use XACRO for maintainable robot descriptions.

Next, let's put this into practice with hands-on exercises!

## Next Steps

Continue to [ROS 2 Lab Exercises](./ros2-exercises.mdx) for practical experience.

---

## References

[^1]: Open Robotics. (2022). URDF Tutorials. *ROS 2 Documentation*. https://docs.ros.org/en/humble/Tutorials/Intermediate/URDF/URDF-Main.html
