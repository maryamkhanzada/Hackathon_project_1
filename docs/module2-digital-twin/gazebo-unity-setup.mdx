# Gazebo & Unity Setup

This guide walks you through installing and configuring both Gazebo and Unity for humanoid robot simulation. By the end, you'll have both simulators integrated with ROS 2.

## Prerequisites

Before starting, ensure you have:

- **Ubuntu 22.04 LTS** (recommended) or Ubuntu 20.04
- **ROS 2 Humble** installed and sourced (from Module 1)
- **At least 8GB RAM** (16GB recommended for Unity)
- **10GB free disk space**
- **GPU** (integrated OK for Gazebo, dedicated recommended for Unity)

:::tip Windows and macOS Users

While Ubuntu is recommended, alternatives exist:
- **Windows**: WSL2 with Ubuntu 22.04, or Docker
- **macOS**: Docker or virtual machine (performance limited)
- **See Appendix**: [Lab Setup Tips](/docs/appendices/lab-setup-tips) for platform-specific guidance

:::

## Part 1: Gazebo Installation

### Gazebo Versions Overview

Gazebo has undergone a major rewrite:

- **Gazebo Classic 11**: Legacy version, still widely used
- **Gazebo Garden**: New architecture, LTS (recommended)
- **Gazebo Harmonic**: Latest stable release (2024)

This guide uses **Gazebo Garden** (works with ROS 2 Humble). Adjust commands for Harmonic if desired.

:::info Naming Note

The new Gazebo is sometimes called "Ignition Gazebo" in older docs. As of 2022, it's officially just "Gazebo" with version names (Garden, Harmonic, etc.).

:::

### Installing Gazebo Garden

#### Method 1: Binary Installation (Recommended)

```bash
# Update package lists
sudo apt update

# Install Gazebo Garden
sudo apt install gz-garden

# Verify installation
gz sim --version
# Should output: Gazebo Sim, version 7.x.x
```

#### Method 2: With ROS 2 Integration

For seamless ROS 2 integration, install the `ros_gz` packages:

```bash
# Install ROS 2 Gazebo packages
sudo apt install ros-humble-ros-gz

# This includes:
# - ros_gz_bridge: ROS 2 <-> Gazebo message translation
# - ros_gz_sim: Launch Gazebo from ROS 2
# - ros_gz_image: Camera/image transport
```

#### Verify Gazebo Installation

```bash
# Launch Gazebo with empty world
gz sim empty.sdf

# You should see the Gazebo GUI with:
# - 3D viewport
# - Entity tree (left panel)
# - Component inspector (right panel)
```

Press `Ctrl+C` in terminal to close.

### Gazebo Configuration

#### Set Physics Engine

Create `~/.gz/sim/7/server.config` to set default physics:

```xml
<?xml version="1.0"?>
<server_config>
  <physics_engine>
    <engine>
      <filename>gz-physics-dartsim-plugin</filename>
    </engine>
  </physics_engine>
</server_config>
```

Available engines:
- `gz-physics-dartsim-plugin` (default, recommended)
- `gz-physics-bullet-plugin` (faster, less accurate)
- `gz-physics-tpe-plugin` (trivial physics, debugging only)

#### Performance Optimization

For better performance on integrated graphics:

```bash
# Edit ~/.gz/sim/7/gui.config
mkdir -p ~/.gz/sim/7
cat > ~/.gz/sim/7/gui.config << 'EOF'
<?xml version="1.0"?>
<window>
  <width>1280</width>
  <height>720</height>
  <plugins>
    <plugin filename="GzScene3D">
      <gz-gui>
        <property key="engine" type="string">ogre2</property>
        <property key="ambient_light" type="string">0.4 0.4 0.4</property>
        <property key="background_color" type="string">0.8 0.8 0.8</property>
      </gz-gui>
    </plugin>
  </plugins>
</window>
EOF
```

### Testing Gazebo with ROS 2

Create a simple ROS 2 + Gazebo test:

```bash
# Launch Gazebo with ROS 2 bridge
ros2 launch ros_gz_sim gz_sim.launch.py gz_args:="empty.sdf"

# In another terminal, check topics
ros2 topic list
# Should see /clock, /model/*, etc.

# Echo the simulation clock
ros2 topic echo /clock
```

## Part 2: Unity Installation

### Installing Unity Hub

Unity Hub manages Unity installations and projects.

#### Download and Install

```bash
# Download Unity Hub (check https://unity.com/download for latest)
wget -O UnityHub.AppImage \
  https://public-cdn.cloud.unity3d.com/hub/prod/UnityHub.AppImage

# Make executable
chmod +x UnityHub.AppImage

# Run Unity Hub
./UnityHub.AppImage
```

Alternatively, install via package manager:

```bash
# Add Unity's GPG key and repository
wget -qO - https://hub.unity3d.com/linux/keys/public | sudo apt-key add -
sudo sh -c 'echo "deb https://hub.unity3d.com/linux/repos/deb stable main" > /etc/apt/sources.list.d/unityhub.list'

# Install Unity Hub
sudo apt update
sudo apt install unityhub
```

#### Install Unity Editor

1. **Open Unity Hub**
2. Go to **Installs** tab
3. Click **Install Editor**
4. Select **2022.3 LTS** (Long Term Support, recommended for robotics)
5. Add modules:
   - ✅ Linux Build Support
   - ✅ Documentation
   - ✅ (Optional) Visual Studio Code integration

Installation takes 10-15 minutes and ~8GB disk space.

### Installing Unity Robotics Packages

Unity's Robotics Hub provides ROS integration.

#### Create a New Unity Project

1. **Open Unity Hub** → **Projects** → **New Project**
2. Select **3D (URP)** template (Universal Render Pipeline for better graphics)
3. Name: `HumanoidRoboticsLab`
4. Click **Create Project**

#### Install Unity Robotics Hub Packages

In Unity Editor:

**Method 1: Package Manager (Recommended)**

1. **Window** → **Package Manager**
2. Click **+** → **Add package from git URL**
3. Enter: `https://github.com/Unity-Technologies/ROS-TCP-Connector.git?path=/com.unity.robotics.ros-tcp-connector`
4. Click **Add**
5. Repeat for Visualizations:
   ```
   https://github.com/Unity-Technologies/URDF-Importer.git?path=/com.unity.robotics.urdf-importer
   ```

**Method 2: Unity Registry**

1. **Edit** → **Project Settings** → **Package Manager**
2. Add scoped registry:
   - **Name**: `Unity Robotics`
   - **URL**: `https://packages.unity.com`
   - **Scope**: `com.unity.robotics`
3. **Package Manager** → **Unity Registry** → search "robotics"
4. Install:
   - **ROS TCP Connector**
   - **URDF Importer**

#### Verify Installation

Check **Window** → **Robotics** menu appears with:
- ROS Settings
- Urdf Importer

### Setting Up ROS-Unity Communication

#### 1. Install ROS-TCP Endpoint (ROS 2 side)

```bash
# Navigate to your ROS 2 workspace
cd ~/ros2_ws/src

# Clone the ROS-TCP Endpoint
git clone https://github.com/Unity-Technologies/ROS-TCP-Endpoint.git

# Install dependencies
cd ~/ros2_ws
rosdep install --from-paths src --ignore-src -r -y

# Build
colcon build --packages-select ros_tcp_endpoint

# Source
source install/setup.bash
```

#### 2. Configure Unity ROS Settings

In Unity Editor:

1. **Robotics** → **ROS Settings**
2. Set **ROS IP Address**: `127.0.0.1` (localhost)
3. Set **ROS Port**: `10000`
4. **Protocol**: `ROS 2`

#### 3. Launch ROS-TCP Endpoint

```bash
# In terminal with ROS 2 sourced
ros2 run ros_tcp_endpoint default_server_endpoint --ros-args -p ROS_IP:=0.0.0.0

# Should output:
# Starting server on 0.0.0.0:10000
```

#### 4. Test Connection

In Unity, create test script `Assets/Scripts/ROSConnectionTest.cs`:

```csharp
using UnityEngine;
using Unity.Robotics.ROSTCPConnector;

public class ROSConnectionTest : MonoBehaviour
{
    void Start()
    {
        ROSConnection.GetOrCreateInstance().Connect();
        Debug.Log("Connected to ROS!");
    }
}
```

Attach to any GameObject, run scene, check Console for "Connected to ROS!".

## Part 3: Importing Robot Models

### Gazebo: Using URDF/SDF Models

#### Download Example Humanoid

```bash
# Clone humanoid model repository (example)
cd ~/ros2_ws/src
git clone https://github.com/ros-controls/ros2_control_demos.git

# Or use your own URDF from Module 1
```

#### Launch in Gazebo

```bash
# Launch Gazebo with robot
ros2 launch ros_gz_sim spawn_robot.launch.py \
  robot_name:=humanoid \
  urdf:=/path/to/your/humanoid.urdf
```

#### Verify in Gazebo

The robot should appear in the 3D viewport. Check:
- All links visible
- Joints movable (if controllers configured)
- No collision warnings in terminal

### Unity: Importing URDF

#### Import URDF into Unity

1. **Assets** → **Create** → **Folder** → name it `URDF`
2. Copy your `humanoid.urdf` and mesh files to `Assets/URDF/`
3. **Robotics** → **Import URDF**
4. Select `humanoid.urdf`
5. Configure import settings:
   - **Axis Type**: Y Axis
   - **Mesh Decomposer**: VHACD (for complex shapes)
6. Click **Import**

The robot appears in the scene hierarchy.

#### Configure Physics

Select the root robot object:

1. **Add Component** → **Articulation Body** (Unity's robot physics)
2. Set **Immovable**: ✅ (for fixed base) or ❌ (for mobile base)
3. For each joint:
   - Select joint GameObject
   - **Articulation Body** → **Joint Type**: Revolute or Prismatic
   - Set **Limits** matching URDF values

#### Add Sensors

**Camera** (for vision):
```csharp
// Add to head link GameObject
GameObject cameraObj = new GameObject("RobotCamera");
cameraObj.transform.parent = headLink.transform;
Camera cam = cameraObj.AddComponent<Camera>();
cam.fieldOfView = 60f;
```

**IMU** (orientation sensing):
```csharp
// Add IMU component (from Unity Robotics packages)
gameObject.AddComponent<ROSImuSensor>();
```

## Performance Tuning

### Gazebo Performance Tips

**Reduce Physics Rate** (if real-time not critical):
```xml
<physics>
  <real_time_update_rate>100</real_time_update_rate>  <!-- Default 1000 -->
</physics>
```

**Disable GUI** (for headless training):
```bash
gz sim -s world.sdf  # Server only, no GUI
```

**Use Simplified Meshes**:
- Visual: High-poly for appearance
- Collision: Low-poly boxes/cylinders for speed

### Unity Performance Tips

**Optimize Physics**:
```csharp
// In Edit → Project Settings → Physics
Time.fixedDeltaTime = 0.01f;  // 100 Hz (default 0.02)
Physics.defaultSolverIterations = 10;  // Increase for stability
```

**Reduce Graphics Load**:
1. **Edit** → **Project Settings** → **Quality**
2. Set **VSync Count**: Don't Sync
3. **Shadows**: Disable or Low Resolution
4. **Anti-Aliasing**: Disabled

**Build for Performance**:
```csharp
// In build settings, disable:
// - Development Build
// - Script Debugging
// Enable:
// - IL2CPP backend (faster than Mono)
```

## Troubleshooting

### Gazebo Issues

**Problem**: "Failed to load plugin" errors

**Solution**:
```bash
# Set Gazebo plugin path
export GZ_SIM_SYSTEM_PLUGIN_PATH=/usr/lib/x86_64-linux-gnu/gz-sim-7/plugins:$GZ_SIM_SYSTEM_PLUGIN_PATH

# Add to ~/.bashrc to persist
echo 'export GZ_SIM_SYSTEM_PLUGIN_PATH=/usr/lib/x86_64-linux-gnu/gz-sim-7/plugins:$GZ_SIM_SYSTEM_PLUGIN_PATH' >> ~/.bashrc
```

**Problem**: Black screen or no rendering

**Solution**:
```bash
# Force software rendering
export LIBGL_ALWAYS_SOFTWARE=1
gz sim empty.sdf
```

**Problem**: ROS 2 bridge not working

**Solution**:
```bash
# Ensure matching ROS_DOMAIN_ID
export ROS_DOMAIN_ID=0

# Check bridge is running
ros2 node list | grep gz_bridge
```

### Unity Issues

**Problem**: ROS connection timeout

**Solution**:
1. Check firewall: `sudo ufw allow 10000/tcp`
2. Verify ROS endpoint running: `ros2 node list | grep tcp_endpoint`
3. Check IP address in Unity ROS Settings (use `127.0.0.1` for localhost)

**Problem**: URDF import errors

**Solution**:
- Ensure mesh paths are relative in URDF
- Check mesh file formats (Unity supports .dae, .fbx, .obj)
- Use **Mesh Decomposer: VHACD** for complex collision

**Problem**: Slow Unity editor performance

**Solution**:
```
Edit → Preferences → GI Cache → Clean Cache
Window → Rendering → Lighting → Auto Generate: OFF
```

## Validation Checklist

Before proceeding, verify:

✅ **Gazebo**:
- [ ] `gz sim --version` shows Garden (7.x) or Harmonic (8.x)
- [ ] `gz sim empty.sdf` launches GUI successfully
- [ ] `ros2 topic list` shows Gazebo topics when bridge running
- [ ] Can spawn robot URDF in Gazebo

✅ **Unity**:
- [ ] Unity Hub opens without errors
- [ ] Unity 2022.3 LTS editor installed
- [ ] ROS TCP Connector package installed
- [ ] Can connect to ROS 2 endpoint (port 10000)
- [ ] Can import URDF files

✅ **Integration**:
- [ ] ROS 2 workspace built with `ros_tcp_endpoint`
- [ ] Can publish ROS messages from Unity to ROS 2
- [ ] Can subscribe to ROS topics in Unity

## Next Steps

With both simulators installed, you're ready to explore realistic sensor simulation. Continue to [Simulating Sensors](./simulating-sensors.mdx) to add cameras, LiDAR, and IMUs to your robot!

---

## References

[^1]: Open Robotics. (2024). Gazebo Installation Guide. *Gazebo Documentation*. https://gazebosim.org/docs/garden/install

[^2]: Unity Technologies. (2023). Unity Robotics Hub. *GitHub Repository*. https://github.com/Unity-Technologies/Unity-Robotics-Hub

[^3]: ROS 2 Documentation. (2024). Using Gazebo with ROS 2. https://docs.ros.org/en/humble/Tutorials/Advanced/Simulators/Gazebo/Gazebo.html

[^4]: Koubaa, A. (Ed.). (2017). *Robot Operating System (ROS): The Complete Reference (Volume 2)*. Springer. ISBN: 978-3-319-54927-9.
